name: Rust Cross-Platform Build and Test

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    build:
        name: ${{ matrix.platform.build_name }}
        runs-on: ${{ matrix.platform.runs_on }}

        strategy:
            fail-fast: false
            matrix:
                platform:
                    - build_name: Linux-x86_64
                      runs_on: ubuntu-latest
                      rust_target: x86_64-unknown-linux-gnu
                      packages: "" # default to all packages

                    - build_name: Linux-x86_64-musl
                      runs_on: ubuntu-latest
                      rust_target: x86_64-unknown-linux-musl
                      packages: "-p nice_common -p nice_client"

                    - build_name: Linux-aarch64
                      runs_on: ubuntu-latest
                      rust_target: aarch64-unknown-linux-gnu
                      packages: "-p nice_common -p nice_client"

                    - build_name: Linux-aarch64-musl
                      runs_on: ubuntu-latest
                      rust_target: aarch64-unknown-linux-musl
                      packages: "-p nice_common -p nice_client"

                    - build_name: Linux-armv7
                      runs_on: ubuntu-latest
                      rust_target: armv7-unknown-linux-gnueabihf
                      packages: "-p nice_common -p nice_client"

                    - build_name: Linux-arm-musl
                      runs_on: ubuntu-latest
                      rust_target: arm-unknown-linux-musleabi
                      packages: "-p nice_common -p nice_client"

                    - build_name: Linux-riscv64
                      runs_on: ubuntu-latest
                      rust_target: riscv64gc-unknown-linux-gnu
                      packages: "-p nice_common -p nice_client"

                    - build_name: FreeBSD-x86_64
                      runs_on: ubuntu-latest
                      rust_target: x86_64-unknown-freebsd
                      packages: "-p nice_common -p nice_client"

                    - build_name: Windows-x86_64
                      runs_on: windows-latest
                      rust_target: x86_64-pc-windows-msvc
                      packages: "-p nice_common -p nice_client"

                    - build_name: Windows-aarch64
                      runs_on: windows-11-arm
                      rust_target: aarch64-pc-windows-msvc
                      packages: "-p nice_common -p nice_client"

                    - build_name: macOS-x86_64
                      runs_on: macOS-latest
                      rust_target: x86_64-apple-darwin
                      packages: "-p nice_common -p nice_client"

                    - build_name: macOS-aarch64
                      runs_on: macOS-latest
                      rust_target: aarch64-apple-darwin
                      packages: "-p nice_common -p nice_client"

        steps:
            - uses: actions/checkout@v4

            - name: Build binaries
              # https://github.com/houseabsolute/actions-rust-cross
              uses: houseabsolute/actions-rust-cross@v1
              with:
                  command: "build"
                  target: ${{ matrix.platform.rust_target }}
                  args: "${{ matrix.platform.packages }} --locked --release"

            - name: Create release artifacts
              # https://github.com/houseabsolute/actions-rust-release
              uses: houseabsolute/actions-rust-release@v0
              with:
                  executable-name: nice_client
                  target: ${{ matrix.platform.rust_target }}
                  # Use a tag like vX.Y.Z to draft a new release
                  release-tag-prefix: "v"
                  changes-file: "CHANGELOG.md"

            - name: Run tests
              # Skip tests for targets that can't run on the host system
              if: ${{ !contains(matrix.platform.rust_target, 'freebsd') }}
              uses: houseabsolute/actions-rust-cross@v1
              with:
                  command: "test"
                  target: ${{ matrix.platform.rust_target }}
                  args: "${{ matrix.platform.packages }} --locked --release --no-fail-fast"
