name: Docker Build and Push

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: nice_client

jobs:
    build-and-push-amd64:
        name: Build (amd64) + Push arch image
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable

            - name: Cache Cargo (amd64)
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: cargo-amd64-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      cargo-amd64-${{ runner.os }}-

            - name: Build nice_client (release)
              run: |
                  cargo build --release --locked -p nice_client

            - name: Stage Docker build context
              run: |
                  rm -rf /tmp/docker-context
                  mkdir -p /tmp/docker-context
                  cp target/release/nice_client /tmp/docker-context/nice_client
                  cp client/Dockerfile.runtime /tmp/docker-context/Dockerfile

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # Per-arch tag. Manifest job will later create the multi-arch tags.
            - name: Build and push arch image (amd64)
              uses: docker/build-push-action@v5
              with:
                  context: /tmp/docker-context
                  file: /tmp/docker-context/Dockerfile
                  platforms: linux/amd64
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-amd64

    build-and-push-arm64:
        name: Build (arm64) + Push arch image
        runs-on: ubuntu-24.04-arm
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: stable

            - name: Cache Cargo (arm64)
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: cargo-arm64-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      cargo-arm64-${{ runner.os }}-

            - name: Build nice_client (release)
              run: |
                  cargo build --release --locked -p nice_client

            - name: Stage Docker build context
              run: |
                  rm -rf /tmp/docker-context
                  mkdir -p /tmp/docker-context
                  cp target/release/nice_client /tmp/docker-context/nice_client
                  cp client/Dockerfile.runtime /tmp/docker-context/Dockerfile

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # Per-arch tag. Manifest job will later create the multi-arch tags.
            - name: Build and push arch image (arm64)
              uses: docker/build-push-action@v5
              with:
                  context: /tmp/docker-context
                  file: /tmp/docker-context/Dockerfile
                  platforms: linux/arm64
                  push: true
                  tags: |
                      ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-arm64

    publish-manifest:
        name: Publish multi-arch manifest
        runs-on: ubuntu-latest
        needs: [build-and-push-amd64, build-and-push-arm64]
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (final tags)
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=ref,event=branch
                      type=ref,event=pr
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=raw,value=latest,enable={{is_default_branch}}
                      type=sha

            - name: Set up Docker Buildx (for imagetools)
              uses: docker/setup-buildx-action@v3

            - name: Create and push multi-arch manifests
              env:
                  FINAL_TAGS: ${{ steps.meta.outputs.tags }}
                  IMAGE_BASE: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
                  SHA: ${{ github.sha }}
              run: |
                  set -euo pipefail

                  AMD_IMAGE="${IMAGE_BASE}:${SHA}-amd64"
                  ARM_IMAGE="${IMAGE_BASE}:${SHA}-arm64"

                  echo "Source images:"
                  echo "  ${AMD_IMAGE}"
                  echo "  ${ARM_IMAGE}"

                  # metadata-action outputs tags separated by newlines
                  echo "${FINAL_TAGS}" | while IFS= read -r tag; do
                    [ -n "${tag}" ] || continue
                    echo "Publishing multi-arch tag: ${tag}"
                    docker buildx imagetools create \
                      -t "${tag}" \
                      "${AMD_IMAGE}" \
                      "${ARM_IMAGE}"
                  done
